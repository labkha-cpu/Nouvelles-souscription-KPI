/* GENERATED 2025-12-11 10:03:03.524367 | SOURCE: 09122025 | NB: 1817 */
/* OPTIMIZED QUERY FOR KPEP
   Logic: Filter Users by KPEP -> Find Latest Event -> Join Attributes ONCE
*/

WITH TargetUsers AS (
    -- 1. Récupération des utilisateurs cibles via KPEP ID (Filtre primaire)
    -- On identifie d'abord les users qui possèdent un des KPEP recherchés
    SELECT
        usr.id,
        usr.email,
        usr.first_name,
        usr.last_name,
        usr.created_timestamp,
        att_kpep.value as kpep_searched -- On garde le KPEP qui a matché pour la ref
    FROM rcia.user_entity usr
    JOIN rcia.user_attribute att_kpep ON usr.id = att_kpep.user_id 
    WHERE att_kpep.name = 'kpepId'
      AND att_kpep.value IN (
          'KPEP00000236079113','KPEP00001044925735','KPEP00000711054832','KPEP00000039992240','KPEP00000749826808','KPEP00001049745719','KPEP00000479192115','KPEP00001037301826','KPEP00001036178608','KPEP00000141752929','KPEP00000179994939','KPEP00000206060341','KPEP00001052160820','KPEP00000296396020','KPEP00000562390925','KPEP00000179909323','KPEP00000837318927','KPEP00000462871723','KPEP00001053487010','KPEP00000031872428','KPEP00000550644434','KPEP00000424454929','KPEP00000960287638','KPEP00000769825028','KPEP00000756628729','KPEP00000104544725','KPEP00000188065218','KPEP00000078608008','KPEP00000921917406','KPEP00000725982541','KPEP00000497981139','KPEP00000144882838','KPEP00000253501925','KPEP00000327952236','KPEP00000118390711','KPEP00000472277038','KPEP00000226532513','KPEP00000968459828','KPEP00000320706529','KPEP00000528273416','KPEP00000729462321','KPEP00000034505525','KPEP00000401881301','KPEP00000823322305','KPEP00001036741711','KPEP00000523711307','KPEP00001041339903','KPEP00000268037317','KPEP00000592332624','KPEP00000147738939','KPEP00001038867113','KPEP00000331934804','KPEP00000013658139','KPEP00000555561927','KPEP00000731340428','KPEP00000302108424','KPEP00000781056434','KPEP00001074860810','KPEP00000384007212','KPEP00000134237210','KPEP00000953175523','KPEP00000666759309','KPEP00000346170018','KPEP00000829392618','KPEP00000490420836','KPEP00000838907234','KPEP00000434200402','KPEP00000544089707','KPEP00000744657517','KPEP00000023126513','KPEP00001042497832','KPEP00000155356022','KPEP00000319992630','KPEP00000339257121','KPEP00001074860305','KPEP00000665473806','KPEP00000028203303','KPEP00000314512034','KPEP00000857326111','KPEP00001048525337','KPEP00000574466127','KPEP00000342423012','KPEP00000212543727','KPEP00000295476523','KPEP00000558972731','KPEP00000335769303','KPEP00000530486715','KPEP00000021647608','KPEP00000397300010','KPEP00000783895230','KPEP00000870347323','KPEP00000532982626','KPEP00000047837032','KPEP00000478162206','KPEP00000136643709','KPEP00000268376608','KPEP00000487594539','KPEP00000428846816','KPEP00000024681220','KPEP00000109189723','KPEP00000249197329','KPEP00000236861323','KPEP00000562893006','KPEP00001051466305','KPEP00001049342620','KPEP00000550864509','KPEP00000498741339','KPEP00001050411903','KPEP00000133957123','KPEP00000929397606','KPEP00000789183434','KPEP00001017510113','KPEP00000321039339','KPEP00001052360501','KPEP00000247078004','KPEP00000533140711','KPEP00001043118321','KPEP00000240732612','KPEP00000489009636','KPEP00001049052719','KPEP00000282258315','KPEP00000457755315','KPEP00000161099400','KPEP00001039862715','KPEP00000479031303','KPEP00001045294628','KPEP00000339028301','KPEP00000200876531','KPEP00000460737618','KPEP00000513024024','KPEP00000542116616','KPEP00000024570202','KPEP00000184519408','KPEP00000200319101','KPEP00001044392032','KPEP00000376274204','KPEP00001076771911','KPEP00000442097412','KPEP00000254366822','KPEP00000181556531','KPEP00000257317040','KPEP00001036945331','KPEP00000239958701','KPEP00000543393921','KPEP00000208557321','KPEP00000423038822','KPEP00000135041127','KPEP00000105491240','KPEP00000347088606','KPEP00000183004016','KPEP00000183759410','KPEP00000079753741','KPEP00000098830705','KPEP00000665595303','KPEP00000836185028','KPEP00000329941016','KPEP00000156506115','KPEP00000038262606','KPEP00000305791016','KPEP00000173671313','KPEP00000570801404','KPEP00000262629838','KPEP00000190509921','KPEP00000338621608','KPEP00000879756030','KPEP00000515182117','KPEP00000031947826','KPEP00000583054016','KPEP00000319533921','KPEP00000687886319','KPEP00000259340935','KPEP00000198378600','KPEP00000145910222','KPEP00000899632509','KPEP00000183158608','KPEP00000308233640','KPEP00000722828240','KPEP00000832557339','KPEP00000073559608','KPEP00000077794723','KPEP00000037872309','KPEP00000723968317','KPEP00000718061240','KPEP00000574140606','KPEP00000666655824','KPEP00001054032202','KPEP00000339002840','KPEP00000461716622','KPEP00000256126723','KPEP00000832591604','KPEP00001043011141','KPEP00000074507638','KPEP00000291726630','KPEP00000346043109','KPEP00000563343921','KPEP00000191164111','KPEP00000578662533','KPEP00000066982913','KPEP00000481587125','KPEP00000447553010','KPEP00000094381331','KPEP00000171536341','KPEP00000555797834','KPEP00000775288622','KPEP00001049201335','KPEP00000508621717','KPEP00000415911018','KPEP00000404251111','KPEP00000311418309','KPEP00000722768026','KPEP00000754815339','KPEP00000505064620','KPEP00000433936004','KPEP00000468812139','KPEP00000513831939','KPEP00000875306715','KPEP00000099804339','KPEP00000471438208','KPEP00000286798313','KPEP00000135313218','KPEP00000048175111','KPEP00000261831939','KPEP00000787168705','KPEP00000036227020','KPEP00000135786101','KPEP00000315114814','KPEP00000136804925','KPEP00000495542109','KPEP00001047201024','KPEP00000237816541','KPEP00000495662133','KPEP00000749309804','KPEP00000212602628','KPEP00001049946006','KPEP00000291651939','KPEP00000128430630','KPEP00000447582713','KPEP00000831011436','KPEP00000531310117','KPEP00000717738808','KPEP00000989624537','KPEP00000340174539','KPEP00000438017739','KPEP00000756795517','KPEP00000244466311','KPEP00001049331838','KPEP00000865423812','KPEP00000143798127','KPEP00000045698828','KPEP00000070115103','KPEP00000443879323','KPEP00000032456228','KPEP00000929263105','KPEP00000333637016','KPEP00000206398824','KPEP00000367059404','KPEP00001046170812','KPEP00001052629040','KPEP00000341074206','KPEP00000535617036','KPEP00000721490014','KPEP00000442155505','KPEP00000259001703','KPEP00000434570406','KPEP00001050410834','KPEP00001038575133','KPEP00000507187901','KPEP00001052088915','KPEP00000439611618','KPEP00000665208802','KPEP00000556179125','KPEP00000123920739','KPEP00000206534133','KPEP00000257378121','KPEP00000090495422','KPEP00000210605911','KPEP00000466021925','KPEP00000086899010','KPEP00000142951806','KPEP00000349201307','KPEP00000764473925','KPEP00000020446206','KPEP00000768227816','KPEP00001051032838','KPEP00000407448119','KPEP00000749074806','KPEP00001048646733','KPEP00001039862917','KPEP00000331597028','KPEP00000537253218','KPEP00000514206707','KPEP00000332359307','KPEP00000147868634','KPEP00000665125408','KPEP00001052146907','KPEP00000258818014','KPEP00000071222935','KPEP00000524668604','KPEP00000070988240','KPEP00001038871111','KPEP00000717720737','KPEP00000304075800','KPEP00000264980525','KPEP00000032971111','KPEP00000345003428','KPEP00000189400212','KPEP00000508021319','KPEP00000573013533','KPEP00000902630602','KPEP00000170316422','KPEP00000750477404','KPEP00001048067335','KPEP00000457428624','KPEP00000867484034','KPEP00000354943818','KPEP00000494684703','KPEP00000789418735','KPEP00000532524119','KPEP00000416109327','KPEP00000332331826','KPEP00000211086428','KPEP00001041276903','KPEP00000965251129','KPEP00000433655816','KPEP00000226887232','KPEP00000070319531','KPEP00000874269315','KPEP00000761995521','KPEP00000432704638','KPEP00000067318105','KPEP00000481397014','KPEP00000024078238','KPEP00000132886931','KPEP00000448971541','KPEP00000590715927','KPEP00000749681222','KPEP00000182402305','KPEP00000090449121','KPEP00001039020434','KPEP00000225452608','KPEP00000355073614','KPEP00000351160022','KPEP00000151685424','KPEP00000073902232','KPEP00000587806236','KPEP00000488587818','KPEP00000282768737','KPEP00000208356327','KPEP00001050415236','KPEP00000913225931','KPEP00000832593422','KPEP00000543161406','KPEP00000398359319','KPEP00000577352032','KPEP00000457613424','KPEP00000374361226','KPEP00000302598915','KPEP00000509265125','KPEP00001037307137','KPEP00000345344335','KPEP00000336518014','KPEP00000463004709','KPEP00001050425109','KPEP00000105630303','KPEP00000450156606','KPEP00000190138141','KPEP00000562957521','KPEP00000342066618','KPEP00000673629802','KPEP00000425345329','KPEP00000358936604','KPEP00000392598434','KPEP00000534245412','KPEP00000298948509','KPEP00000115093913','KPEP00000332692723','KPEP00000874270830','KPEP00000248005640','KPEP00000920260325','KPEP00000579989127','KPEP00000203266533','KPEP00000574151228','KPEP00000903405624','KPEP00000905532036','KPEP00000133465117','KPEP00001042558004','KPEP00001048074927','KPEP00000020405519','KPEP00000828865337','KPEP00000460124721','KPEP00000398285234','KPEP00000446625113','KPEP00000036520515','KPEP00000166158119','KPEP00001045314820','KPEP00000477424420','KPEP00000282661818','KPEP00001045831521','KPEP00000265398505','KPEP00000101378834','KPEP00001050408713','KPEP00000856407624','KPEP00000516915202','KPEP00000119188206','KPEP00000458787404','KPEP00000454018123','KPEP00000414823925','KPEP00001046174507','KPEP00000163321604','KPEP00000424289109','KPEP00000129139319','KPEP00000055929826','KPEP00000934416707','KPEP00000144363006','KPEP00000281874541','KPEP00000271141723','KPEP00000728944913','KPEP00000355635000','KPEP00001044691141','KPEP00000665106630','KPEP00000953869937','KPEP00001045339313','KPEP00000309628040','KPEP00000521619707','KPEP00000376255426','KPEP00000513587733','KPEP00000239654323','KPEP00001041170228','KPEP00000855034628','KPEP00000239563800','KPEP00001038874907','KPEP00000581896836','KPEP00000840914935','KPEP00000082432533','KPEP00000171469040','KPEP00000571635125','KPEP00000157635208','KPEP00000359300026','KPEP00001037304208','KPEP00000718067317','KPEP00001039859626','KPEP00000589173012','KPEP00000493959820','KPEP00000092765501','KPEP00000534709937','KPEP00000832581226','KPEP00000215517933','KPEP00000726295824','KPEP00001049848741','KPEP00000203356913','KPEP00001077471535','KPEP00000042739040','KPEP00000405326715','KPEP00000578240210','KPEP00000592781216','KPEP00000077528709','KPEP00000415386321','KPEP00000368485527','KPEP00000478518137','KPEP00000133740036','KPEP00000877336729','KPEP00000835145911','KPEP00000344527717','KPEP00000497560735','KPEP00000070253400','KPEP00000542821610','KPEP00000562374630','KPEP00000059769131','KPEP00000630902335','KPEP00000208926921','KPEP00000527185313','KPEP00001053420113','KPEP00000061196323','KPEP00000165994016','KPEP00000781253733','KPEP00000453858927','KPEP00000060925402','KPEP00000866035438','KPEP00001036160537','KPEP00000055566202','KPEP00000815545016','KPEP00000275519638','KPEP00000170590533','KPEP00000982644903','KPEP00000073656915','KPEP00000348944602','KPEP00000166768735','KPEP00000123834820','KPEP00000304050339','KPEP00000082256840','KPEP00000407137319','KPEP00000523532222','KPEP00000682778008','KPEP00000385892911','KPEP00000174763414','KPEP00000503790101','KPEP00000560420721','KPEP00000532319834','KPEP00000032103731','KPEP00001039857202','KPEP00000524699822','KPEP00000527894810','KPEP00000263019630','KPEP00000248359206','KPEP00000564434911','KPEP00000666170703','KPEP00000305240816','KPEP00000651040224','KPEP00000309395121','KPEP00000027826212','KPEP00000036433729','KPEP00000734474941','KPEP00000021596400','KPEP00000122469517','KPEP00000718483925','KPEP00000263598018','KPEP00000338050206','KPEP00001052159103','KPEP00000781714723','KPEP00001042651010','KPEP00001042931240','KPEP00000466300539','KPEP00000203460339','KPEP00000081250717','KPEP00000832887725','KPEP00000237254608','KPEP00000423401436','KPEP00000750003814','KPEP00000050270103','KPEP00000056743414','KPEP00000033934224','KPEP00000324236507','KPEP00000352216907','KPEP00000537584311','KPEP00000237531101','KPEP00000183314210','KPEP00000052279824','KPEP00000365577612','KPEP00000504162529','KPEP00001074859640','KPEP00000653898303','KPEP00000453197406','KPEP00000225552137','KPEP00000197293527','KPEP00000170984121','KPEP00000449122741','KPEP00000082289834','KPEP00001031563212','KPEP00000734224212','KPEP00001039374808','KPEP00000263365907','KPEP00000203971628','KPEP00000144263519','KPEP00000031063301','KPEP00000267433830','KPEP00000899958030','KPEP00000749740527','KPEP00000367546040','KPEP00000147617804','KPEP00000145759628','KPEP00000516859230','KPEP00000479920533','KPEP00000032746735','KPEP00000356336038','KPEP00001044989804','KPEP00000915038412','KPEP00000215888804','KPEP00000503090822','KPEP00000105652010','KPEP00001041609410','KPEP00000913868632','KPEP00000960239418','KPEP00000090235830','KPEP00001036916537','KPEP00001054561705','KPEP00000331474723','KPEP00000074753115','KPEP00000049405913','KPEP00000555595325','KPEP00000229768129','KPEP00000384331622','KPEP00000339726612','KPEP00000749053040','KPEP00001043027032','KPEP00000229941137','KPEP00001037295101','KPEP00001043110426','KPEP00000452796428','KPEP00001040510424','KPEP00000513916402','KPEP00000386164236','KPEP00000127511032','KPEP00001038881127','KPEP00000580484020','KPEP00000107398040','KPEP00000374034131','KPEP00000453717541','KPEP00000977203117','KPEP00000563405305','KPEP00000321670913','KPEP00000246217610','KPEP00000023458515','KPEP00000048294630','KPEP00000134240703','KPEP00000664224428','KPEP00000299581236','KPEP00001039849610','KPEP00000329832119','KPEP00001045828735','KPEP00000591293204','KPEP00000146882240','KPEP00000123559800','KPEP00000219675125','KPEP00000385675622','KPEP00000479799802','KPEP00000582172824','KPEP00000098387222','KPEP00000033528903','KPEP00001041746739','KPEP00000171952705','KPEP00000805774604','KPEP00000078935608','KPEP00001037308610','KPEP00000331363402','KPEP00000513197537','KPEP00000416398319','KPEP00000906465707','KPEP00000554668337','KPEP00000481099622','KPEP00000082067234','KPEP00000422299521','KPEP00001038110204','KPEP00000787750426','KPEP00000837106301','KPEP00000415646014','KPEP00000581788806','KPEP00001049944937','KPEP00000293034606','KPEP00000440088238','KPEP00000749134919','KPEP00000286561901','KPEP00000389944438','KPEP00001050426725','KPEP00000318866222','KPEP00000780936814','KPEP00000200745321','KPEP00001036921907','KPEP00000579066903','KPEP00000095768602','KPEP00000460994020','KPEP00000913090117','KPEP00000441638602','KPEP00000571572428','KPEP00000293614509','KPEP00000144540416','KPEP00000650195519','KPEP00000544787109','KPEP00001053783333','KPEP00000037926000','KPEP00000393660630','KPEP00000864861416','KPEP00001046131901','KPEP00000190847234','KPEP00000527821230','KPEP00000133735432','KPEP00000322747527','KPEP00000392042519','KPEP00000900710234','KPEP00001044744529','KPEP00000542590004','KPEP00000709925739','KPEP00000315180701','KPEP00000153938038','KPEP00000458110034','KPEP00000367220721','KPEP00000138370515','KPEP00000781318913','KPEP00000589399711','KPEP00000257100416','KPEP00000611501424','KPEP00000243381137','KPEP00000357517307','KPEP00000551591008','KPEP00000997571501','KPEP00000134819739','KPEP00001031124030','KPEP00000387369636','KPEP00001054189723','KPEP00000929951240','KPEP00000478227529','KPEP00000478894117','KPEP00000194473004','KPEP00000117598123','KPEP00000751838002','KPEP00000273249618','KPEP00001049346618','KPEP00000397523014','KPEP00000048693630','KPEP00000728529214','KPEP00001074866626','KPEP00000099878020','KPEP00000463397228','KPEP00000114630238','KPEP00000464362016','KPEP00000513069012','KPEP00000877356618','KPEP00000487845125','KPEP00000345244200','KPEP00001046193024','KPEP00000591384434','KPEP00000178474640','KPEP00000393135428','KPEP00000108828826','KPEP00000438355111','KPEP00000385341600','KPEP00000150587810','KPEP00000150946931','KPEP00000578893937','KPEP00000715021105','KPEP00000360103135','KPEP00000377722640','KPEP00000514880121','KPEP00000072242626','KPEP00000050555341','KPEP00001046191206','KPEP00000765573719','KPEP00000069703705','KPEP00000216722929','KPEP00000472174925','KPEP00000404636905','KPEP00000151789414','KPEP00000351693119','KPEP00000592000723','KPEP00000449134533','KPEP00000482091226','KPEP00000386319838','KPEP00000078351404','KPEP00000865417937','KPEP00000230198709','KPEP00001049318733','KPEP00000179632931','KPEP00000579150137','KPEP00000858549927','KPEP00000289916834','KPEP00000041476919','KPEP00000753266507','KPEP00000713831840','KPEP00000333764430','KPEP00000146526915','KPEP00000789018422','KPEP00000753839525','KPEP00000174364111','KPEP00000444322200','KPEP00000578931131','KPEP00000020640113','KPEP00000274292531','KPEP00000433073430','KPEP00000277614428','KPEP00000757006123','KPEP00000365620925','KPEP00000432612339','KPEP00001045818517','KPEP00000360953715','KPEP00000392573133','KPEP00000559507402','KPEP00001040363626','KPEP00000202495913','KPEP00000644784707','KPEP00000221290408','KPEP00000228989412','KPEP00000678258000','KPEP00000274354824','KPEP00000725630709','KPEP00001036930105','KPEP00001049061725','KPEP00001065731222','KPEP00000118080820','KPEP00000035388838','KPEP00000749205511','KPEP00000060474529','KPEP00000064218000','KPEP00000365719040','KPEP00000201892527','KPEP00000244926838','KPEP00000256314612','KPEP00000004109216','KPEP00000089908331','KPEP00000705329323','KPEP00000292260535','KPEP00000373457721','KPEP00000179622410','KPEP00000902605705','KPEP00000558941715','KPEP00000227861026','KPEP00000386625630','KPEP00000790460335','KPEP00001052170735','KPEP00000838352733','KPEP00000098408828','KPEP00000280668838','KPEP00000137746028','KPEP00000061078521','KPEP00000414033517','KPEP00000023012507','KPEP00000847808305','KPEP00000562689024','KPEP00000509743319','KPEP00000101993709','KPEP00000298988531','KPEP00000471407537','KPEP00001051025608','KPEP00000752225109','KPEP00000425068331','KPEP00000134709731','KPEP00000259357028','KPEP00000231721735','KPEP00000065208030','KPEP00000515613505','KPEP00000321350501','KPEP00000132346402','KPEP00000960160931','KPEP00001045811228','KPEP00000527799119','KPEP00000450583230','KPEP00000034271133','KPEP00000089654513','KPEP00000249230828','KPEP00000110852620','KPEP00001054532608','KPEP00000038602402','KPEP00001042500719','KPEP00000036610937','KPEP00000465694325','KPEP00000174111303','KPEP00000832873509','KPEP00000038477816','KPEP00000503733119','KPEP00000071850006','KPEP00000401166636','KPEP00000336064010','KPEP00001046191610','KPEP00000532585040','KPEP00001047459404','KPEP00000911147638','KPEP00000049682103','KPEP00001038293733','KPEP00000459741713','KPEP00000673597919','KPEP00001043635224','KPEP00000493019727','KPEP00000086172107','KPEP00000239684632','KPEP00001048055240','KPEP00000348915606','KPEP00000574597901','KPEP00000523096432','KPEP00000184358941','KPEP00001049342216','KPEP00001052171703','KPEP00000228380109','KPEP00000057966321','KPEP00000263594121','KPEP00000505923137','KPEP00000405597232','KPEP00000339883022','KPEP00000066096511','KPEP00000115636016','KPEP00000709401000','KPEP00000098532202','KPEP00000234370117','KPEP00000887920325','KPEP00000348725133','KPEP00000021162832','KPEP00000082322525','KPEP00000787930723','KPEP00000904850121','KPEP00000210542305','KPEP00001053100812','KPEP00000467801513','KPEP00000486635929','KPEP00000301638933','KPEP00000057038929','KPEP00000198524228','KPEP00001038652206','KPEP00000090127800','KPEP00000417162315','KPEP00000784005903','KPEP00000085774218','KPEP00000488589737','KPEP00000435734513','KPEP00000194375840','KPEP00000118055620','KPEP00000563143028','KPEP00001052149634','KPEP00000378952129','KPEP00000829385430','KPEP00001044322913','KPEP00000953609335','KPEP00001043119230','KPEP00000499544608','KPEP00000820568317','KPEP00000147397426','KPEP00000761162406','KPEP00000397778810','KPEP00000164266705','KPEP00000578827705','KPEP00000516997426','KPEP00000318751004','KPEP00001037314729','KPEP00000665916422','KPEP00001079968717','KPEP00000573624006','KPEP00000050703107','KPEP00000224673731','KPEP00000132355206','KPEP00000593426139','KPEP00000422456436','KPEP00000562675414','KPEP00000515752711','KPEP00000158509818','KPEP00000275455123','KPEP00000074162834','KPEP00000797638800','KPEP00000313345301','KPEP00000967121602','KPEP00000515513311','KPEP00000300745141','KPEP00000231494733','KPEP00000458920331','KPEP00000217458131','KPEP00000873326537','KPEP00000574316703','KPEP00000116567204','KPEP00000518081430','KPEP00000230388214','KPEP00000072483802','KPEP00000264634307','KPEP00000124287814','KPEP00000524391606','KPEP00000352085234','KPEP00000036700307','KPEP00000116454612','KPEP00000783920430','KPEP00000275056022','KPEP00000450377228','KPEP00000146433808','KPEP00000581718416','KPEP00000279736034','KPEP00000478070412','KPEP00000300579018','KPEP00000117649432','KPEP00000976821725','KPEP00000713443925','KPEP00000098208802','KPEP00000015911317','KPEP00000148229026','KPEP00000227717317','KPEP00000046590339','KPEP00000208314327','KPEP00000458456614','KPEP00000564413002','KPEP00000081593602','KPEP00001048636515','KPEP00000532499424','KPEP00000172025317','KPEP00000212472125','KPEP00000188855323','KPEP00000895698523','KPEP00000263619119','KPEP00000478121822','KPEP00001050428400','KPEP00000095784535','KPEP00000049973418','KPEP00000047513935','KPEP00000118035428','KPEP00000134173503','KPEP00001039444634','KPEP00000363124913','KPEP00000461531620','KPEP00000293759127','KPEP00000243310141','KPEP00000578702513','KPEP00001050556016','KPEP00000435666404','KPEP00000426384101','KPEP00000915540434','KPEP00000225189119','KPEP00000144754313','KPEP00001045817204','KPEP00000234910141','KPEP00000393490812','KPEP00000697720337','KPEP00000571964341','KPEP00000290139131','KPEP00000422658701','KPEP00000265348913','KPEP00000127484620','KPEP00000541660331','KPEP00000514207717','KPEP00000033602727','KPEP00000472202406','KPEP00000092542800','KPEP00000351707840','KPEP00000143160131','KPEP00000126410329','KPEP00000526730139','KPEP00000533998925','KPEP00000153972808','KPEP00000675113715','KPEP00000030871919','KPEP00000714388521','KPEP00000160482505','KPEP00000981336927','KPEP00000389135513','KPEP00000511535406','KPEP00000435171915','KPEP00000477270737','KPEP00001038568711','KPEP00000463231812','KPEP00000022257214','KPEP00000049510509','KPEP00000370233232','KPEP00000416052606','KPEP00000178413719','KPEP00000816073307','KPEP00000261927024','KPEP00000322634935','KPEP00000900028117','KPEP00001037304006','KPEP00000429470436','KPEP00000994572600','KPEP00000493452428','KPEP00000118587909','KPEP00000438781230','KPEP00000207692424','KPEP00000493736715','KPEP00000723985319','KPEP00000537581828','KPEP00000487248422','KPEP00000365638129','KPEP00000231495600','KPEP00000842372234','KPEP00000295966509','KPEP00001047591826','KPEP00000089791236','KPEP00000098335105','KPEP00000153829200','KPEP00001045813004','KPEP00001074866828','KPEP00000283539315','KPEP00000525034004','KPEP00000593184719','KPEP00000255366220','KPEP00000762086305','KPEP00000301674309','KPEP00000546872228','KPEP00000037301210','KPEP00000747010224','KPEP00000348053537','KPEP00000328542012','KPEP00000313419428','KPEP00000059771917','KPEP00000337148115','KPEP00000237409907','KPEP00001049458705','KPEP00000387737418','KPEP00000543005804','KPEP00000832763501','KPEP00000429035513','KPEP00000522253806','KPEP00000828960927','KPEP00000351000523','KPEP00000815532517','KPEP00000419771222','KPEP00000543324541','KPEP00000305085719','KPEP00000841848808','KPEP00000087720131','KPEP00000462503234','KPEP00000480103111','KPEP00000970066610','KPEP00000152901404','KPEP00000051145319','KPEP00000135926418','KPEP00001053972232','KPEP00000498261630','KPEP00000063719614','KPEP00000159678731','KPEP00000326717436','KPEP00000724823804','KPEP00000191353515','KPEP00000172222010','KPEP00000666621517','KPEP00000832593018','KPEP00000542114436','KPEP00000038554628','KPEP00000221223309','KPEP00000203696709','KPEP00000053871725','KPEP00000046698933','KPEP00000291039202','KPEP00000781163210','KPEP00000110992735','KPEP00000367272939','KPEP00001043117210','KPEP00000902610107','KPEP00000078965513','KPEP00000398274511','KPEP00000342724301','KPEP00000866601125','KPEP00000274905226','KPEP00000900257703','KPEP00000217540616','KPEP00000749783941','KPEP00000351323721','KPEP00000467116711','KPEP00000752386123','KPEP00000488514440','KPEP00001040296830','KPEP00000252940438','KPEP00000020693501','KPEP00000756226539','KPEP00000212618822','KPEP00000228602608','KPEP00000349676210','KPEP00000736308119','KPEP00000083382238','KPEP00000175912135','KPEP00000401879626','KPEP00000170040535','KPEP00000077087002','KPEP00000818482432','KPEP00000054348404','KPEP00000845252626','KPEP00000065282923','KPEP00000774890632','KPEP00000555490325','KPEP00000388688133','KPEP00000027663523','KPEP00000414223729','KPEP00000295666028','KPEP00000139054105','KPEP00000994634430','KPEP00000678058925','KPEP00000416345335','KPEP00000783919218','KPEP00000387266412','KPEP00001051677315','KPEP00000055777717','KPEP00001044929531','KPEP00000329746604','KPEP00000351260418','KPEP00000849650531','KPEP00000057597327','KPEP00000299939709','KPEP00001049046701','KPEP00000253602220','KPEP00000143534537','KPEP00000729222416','KPEP00000964896107','KPEP00001045815529','KPEP00000143381721','KPEP00000309103301','KPEP00000817043810','KPEP00000498493800','KPEP00000546119317','KPEP00001037297424','KPEP00000450753309','KPEP00000353213519','KPEP00000206384204','KPEP00000020719206','KPEP00000932454802','KPEP00000042659400','KPEP00001054504521','KPEP00001039864735','KPEP00000487250501','KPEP00000835676323','KPEP00000385886834','KPEP00000296418737','KPEP00000150644329','KPEP00001045811632','KPEP00000327010628','KPEP00000723972315','KPEP00000257425836','KPEP00000832716131','KPEP00000202825634','KPEP00000077981038','KPEP00001045177735','KPEP00000293751030','KPEP00001045398214','KPEP00000154631139','KPEP00000184472602','KPEP00000476655820','KPEP00000671188028','KPEP00000196961929','KPEP00000111152739','KPEP00000831743911','KPEP00000076389701','KPEP00000262011024','KPEP00000051300315','KPEP00000286813236','KPEP00000300496533','KPEP00000904587541','KPEP00000347333721','KPEP00000668408234','KPEP00000666911822','KPEP00000919991222','KPEP00000442832210','KPEP00000284165418','KPEP00000020615216','KPEP00000905945614','KPEP00000191308426','KPEP00000484806707','KPEP00001038989519','KPEP00000291726226','KPEP00000664547323','KPEP00000301096022','KPEP00000929202933','KPEP00000669970129','KPEP00000395495222','KPEP00000867939309','KPEP00000341728337','KPEP00000738492725','KPEP00000234446020','KPEP00000669057618','KPEP00000063738030','KPEP00000469150723','KPEP00001043830907','KPEP00000127936604','KPEP00000474564927','KPEP00000222258327','KPEP00000053220321','KPEP00000062008741','KPEP00000364935416','KPEP00000783376004','KPEP00001046595820','KPEP00000020318127','KPEP00000722468412','KPEP00000039193937','KPEP00000070350707','KPEP00000340697418','KPEP00000156259224','KPEP00000573185026','KPEP00000011210002','KPEP00001040379618','KPEP00000039891541','KPEP00000491189537','KPEP00000722392206','KPEP00000509319321','KPEP00000117908822','KPEP00000960160123','KPEP00000457645307','KPEP00000783381113','KPEP00000063042000','KPEP00000005114531','KPEP00000295384022','KPEP00000234503608','KPEP00000081306630','KPEP00000781813040','KPEP00001045040709','KPEP00000098928618','KPEP00000151344618','KPEP00001052153329','KPEP00000161076523','KPEP00000038275711','KPEP00000586769905','KPEP00001048071434','KPEP00000450815139','KPEP00001051694923','KPEP00000180319812','KPEP00000486463022','KPEP00000374479028','KPEP00000132923721','KPEP00000961082103','KPEP00000450256236','KPEP00000574751929','KPEP00000571842802','KPEP00000376214032','KPEP00000739503511','KPEP00000351723327','KPEP00000672317929','KPEP00000183315018','KPEP00000184768319','KPEP00000104743236','KPEP00000143929337','KPEP00000757546913','KPEP00001053444707','KPEP00000936991610','KPEP00000722318626','KPEP00000554527313','KPEP00000311114032','KPEP00000300490919','KPEP00000376458600','KPEP00000841282717','KPEP00000960257632','KPEP00000554287004','KPEP00000393241901','KPEP00000940343210','KPEP00000319296339','KPEP00000486195939','KPEP00000126114006','KPEP00001051685311','KPEP00000051458501','KPEP00001045167719','KPEP00000105281501','KPEP00000734735038','KPEP00000305839640','KPEP00000752428325','KPEP00000668995022','KPEP00000327864440','KPEP00000187981319','KPEP00000274415139','KPEP00000569850428','KPEP00000032468323','KPEP00000820573022','KPEP00000718069539','KPEP00000926575812','KPEP00000247422202','KPEP00000904303111','KPEP00000404484030','KPEP00000782861828','KPEP00000202571412','KPEP00000225885915','KPEP00000181943335','KPEP00000096508610','KPEP00000292662624','KPEP00000155358000','KPEP00000203858430','KPEP00000290074818','KPEP00000543276927','KPEP00000532390830','KPEP00000244210414','KPEP00000310114129','KPEP00000404111139','KPEP00000381382010','KPEP00000322411729','KPEP00001045814923','KPEP00000190305939','KPEP00000271946103','KPEP00000823981503','KPEP00000648156541','KPEP00000257217309','KPEP00001041453505','KPEP00000370666539','KPEP00000031435022','KPEP00000262298703','KPEP00000938611539','KPEP00000476525115','KPEP00000782326812','KPEP00000498862432','KPEP00000046776915','KPEP00000180072719','KPEP00000736574941','KPEP00000467090501','KPEP00000174958533','KPEP00000181640329','KPEP00000301446440','KPEP00000865735016','KPEP00000587700024','KPEP00000448838816','KPEP00000356311040','KPEP00000836693834','KPEP00000056458521','KPEP00001052567816','KPEP00000398434212','KPEP00000273256402','KPEP00000201635317','KPEP00000059820541','KPEP00000245550921','KPEP00000477257733','KPEP00001050318333','KPEP00000761726923','KPEP00000277924723','KPEP00000311124107','KPEP00000383147424','KPEP00000444350733','KPEP00000417085503','KPEP00000930031040','KPEP00000786891808','KPEP00000051965430','KPEP00000257094600','KPEP00000245010838','KPEP00000650244808','KPEP00000902027721','KPEP00000194406713','KPEP00000487719832','KPEP00000536281200','KPEP00000153838408','KPEP00000875014432','KPEP00000748617006','KPEP00000227727434','KPEP00000041706707','KPEP00000283794101','KPEP00000509174341','KPEP00000330110531','KPEP00001047541224','KPEP00000842318501','KPEP00000430217834','KPEP00000380761319','KPEP00000415892501','KPEP00000870820913','KPEP00000072037331','KPEP00000395247220','KPEP00000471733824','KPEP00000833931000','KPEP00000124207105','KPEP00000044770527','KPEP00000342542935','KPEP00000301318319','KPEP00000406029731','KPEP00000116849816','KPEP00000423684006','KPEP00000458234519','KPEP00000663267333','KPEP00000183435909','KPEP00000591615434','KPEP00000124906224','KPEP00000902493214','KPEP00000979786521','KPEP00000532884410','KPEP00000389330430','KPEP00000668281325','KPEP00000143335319','KPEP00000035181927','KPEP00000913886139','KPEP00000666142818','KPEP00000686111840','KPEP00000835636141','KPEP00000035853725','KPEP00000341118428','KPEP00000047171311','KPEP00000574577911','KPEP00000282406224','KPEP00000780120238','KPEP00000781425125','KPEP00000382551428','KPEP00001053457206','KPEP00000835357022','KPEP00000198568307','KPEP00000171224228','KPEP00000119603341','KPEP00000929404634','KPEP00000517089826','KPEP00000459023816','KPEP00000203755105','KPEP00000718039432','KPEP00000193213206','KPEP00000472823240','KPEP00000273905727','KPEP00001036500636','KPEP00001048055905','KPEP00001049798341','KPEP00000361485701','KPEP00001043683705','KPEP00000666635834','KPEP00000578659503','KPEP00000104557830','KPEP00000587375715','KPEP00000425807531','KPEP00000764695111','KPEP00000050941539','KPEP00000784951408','KPEP00000868149713','KPEP00000404461515','KPEP00000844199133','KPEP00000401311717','KPEP00000523692630','KPEP00000247352418','KPEP00000188048620','KPEP00000248893414','KPEP00000592764618','KPEP00000370772709','KPEP00000079728701','KPEP00000181417628','KPEP00000096242537','KPEP00000191149331','KPEP00000237404638','KPEP00001047732606','KPEP00000643761927','KPEP00001045311226','KPEP00000582443240','KPEP00000321190640','KPEP00000935109606','KPEP00000324241414','KPEP00000558774927','KPEP00000258918006','KPEP00000531156636','KPEP00000549405939','KPEP00000364634430','KPEP00000164682808','KPEP00000151609824','KPEP00000563002812','KPEP00000933886034','KPEP00000076124537','KPEP00001039193804','KPEP00000228773436','KPEP00000027512929','KPEP00000077569337','KPEP00001050972725','KPEP00000253523935','KPEP00000160969907','KPEP00000670522206','KPEP00000452885436','KPEP00000586643501','KPEP00000509719533','KPEP00000732154117','KPEP00000209073315','KPEP00000874079608','KPEP00000507140026','KPEP00000435668222','KPEP00000476250137','KPEP00000670968214','KPEP00000539736933','KPEP00000119222311','KPEP00000940860012','KPEP00000398112933','KPEP00000105180541','KPEP00000728511707','KPEP00000673276337','KPEP00000507045404','KPEP00000725235808','KPEP00000235177022','KPEP00000345657214','KPEP00000201888024','KPEP00000394713012','KPEP00000641915240','KPEP00000722452016','KPEP00000497155212','KPEP00000095253618','KPEP00000452155604','KPEP00000174337539','KPEP00000340493032','KPEP00001041286919','KPEP00000416550832','KPEP00000110612513','KPEP00000088438331','KPEP00000271840901','KPEP00000666019705','KPEP00000505064115','KPEP00000861271325','KPEP00000220993521','KPEP00000519059020','KPEP00000754716618','KPEP00000366801933','KPEP00000043158131','KPEP00000169490941','KPEP00001037769238','KPEP00000173670707','KPEP00000725428705','KPEP00000028227131','KPEP00000312668436','KPEP00000752375703','KPEP00000030852030','KPEP00000479544107','KPEP00000095169012','KPEP00000487815523','KPEP00001010445410','KPEP00001051626915','KPEP00000357658937','KPEP00000081430509','KPEP00000064624028','KPEP00000153765535','KPEP00000429478533','KPEP00000723484408','KPEP00000068903828','KPEP00000783671418','KPEP00000430367721','KPEP00000439714539','KPEP00000592371737','KPEP00001044417838','KPEP00000244394406','KPEP00000219652206','KPEP00000305351632','KPEP00000336253919','KPEP00001041654036','KPEP00000146941806','KPEP00000077548539','KPEP00000936017715','KPEP00000169747040','KPEP00001038002822','KPEP00000301486420','KPEP00000832989131','KPEP00000783472141','KPEP00000289715032','KPEP00000832618016','KPEP00001036143535','KPEP00000781166804','KPEP00000033455626','KPEP00000250329713','KPEP00000149295826','KPEP00000277882218','KPEP00000590769214','KPEP00000303085307','KPEP00001039207717','KPEP00001046608420','KPEP00000300519814','KPEP00000276600208','KPEP00000867554626','KPEP00000283230434','KPEP00000259114741','KPEP00000537760206','KPEP00000593155723','KPEP00000533481921','KPEP00000835693325','KPEP00000379645028','KPEP00000402968234','KPEP00001046669804','KPEP00000478415216','KPEP00000358958614','KPEP00000122965319','KPEP00000561269727','KPEP00000930701929','KPEP00000118557903','KPEP00000504258321','KPEP00000133259115','KPEP00000900804309','KPEP00000129648731','KPEP00000290201727','KPEP00000518594234','KPEP00001047189737','KPEP00000317129038','KPEP00000202365915','KPEP00000411044127','KPEP00000132130224','KPEP00000430577014','KPEP00000428537026','KPEP00000175896909','KPEP00000514945040','KPEP00000125393525','KPEP00000911391137','KPEP00000199754929','KPEP00000063230941','KPEP00000075554204','KPEP00000723334521','KPEP00000516411808','KPEP00000858075327','KPEP00000534108529','KPEP00000564476507','KPEP00000066134008','KPEP00000849093707','KPEP00001052169523','KPEP00000666225000','KPEP00000941692824','KPEP00000401853517','KPEP00000138493426','KPEP00000210315707','KPEP00001049413010','KPEP00000250292620','KPEP00000599421416','KPEP00000310364008','KPEP00000086811315','KPEP00001044240327','KPEP00000666522333','KPEP00000590214612','KPEP00000087204137','KPEP00000517609717','KPEP00000386868624','KPEP00000928720236','KPEP00001046607006','KPEP00000581969709','KPEP00000231791216','KPEP00001043553000','KPEP00000034586537','KPEP00000155023919','KPEP00000047200105','KPEP00000724602517','KPEP00000220509814','KPEP00000256363135','KPEP00000153674608','KPEP00000119605218','KPEP00000054377703','KPEP00000442030111','KPEP00000456908329','KPEP00001041765921','KPEP00000718659820','KPEP00000303718539','KPEP00000299749901','KPEP00000498327214','KPEP00000046941523','KPEP00000940985103','KPEP00000813269323','KPEP00000190312016','KPEP00000528490301','KPEP00000208488101','KPEP00000234329632','KPEP00000457332529','KPEP00000114742022','KPEP00000846386828','KPEP00000496893036','KPEP00001047465725','KPEP00000129769622','KPEP00000541261836','KPEP00000580124234','KPEP00000238941737','KPEP00000268784008','KPEP00000040553525','KPEP00000039161002','KPEP00001037777436','KPEP00001040358517','KPEP00000752354602','KPEP00000213238806','KPEP00000901552212','KPEP00000452202713','KPEP00000377083129','KPEP00000200515634','KPEP00000906599905','KPEP00000485324115','KPEP00000900419929','KPEP00000513770917','KPEP00000376637424','KPEP00001044356311','KPEP00000110845230','KPEP00000665996020','KPEP00001042720432','KPEP00000379944903','KPEP00000901552313','KPEP00000030617941','KPEP00000593403927','KPEP00000524733018','KPEP00000443645436','KPEP00000036696612','KPEP00000143330109','KPEP00000200745927','KPEP00000954146834','KPEP00000726505622','KPEP00000387769806','KPEP00001039232816','KPEP00000865417028','KPEP00000450247331','KPEP00000182296034','KPEP00000550279337','KPEP00000190312420','KPEP00000069194537','KPEP00000134499731','KPEP00000227815331','KPEP00000051552517','KPEP00000271571840','KPEP00000206619202','KPEP00000388339836','KPEP00000097995107','KPEP00000874679804','KPEP00000718506238','KPEP00000082903337','KPEP00000452227812','KPEP00000210262925','KPEP00000021228820','KPEP00000080716711','KPEP00000097445210','KPEP00000592315117','KPEP00000257940315','KPEP00000403420218','KPEP00000577416808','KPEP00000076503707','KPEP00000222229129','KPEP00000318655111','KPEP00001039865341','KPEP00000552753541','KPEP00000318083709','KPEP00000341172422','KPEP00000495363630','KPEP00000323813418','KPEP00000831040028','KPEP00000444322907','KPEP00000145825818','KPEP00000502977220','KPEP00000546401020','KPEP00000236496731','KPEP00000339534523','KPEP00001037303341','KPEP00000666447802','KPEP00000452110818','KPEP00000559051622','KPEP00000549411208','KPEP00000301586917','KPEP00000059528115','KPEP00000114837208','KPEP00000528223016','KPEP00000243620234','KPEP00000392831008','KPEP00000447852220','KPEP00000375260026','KPEP00000290499523','KPEP00000740870228','KPEP00000394119440','KPEP00000757133032','KPEP00000498893002','KPEP00000349485838','KPEP00000197293325','KPEP00000754823941','KPEP00000088936616','KPEP00000837907735','KPEP00000429060612','KPEP00000884813436','KPEP00001040311812','KPEP00000781969105','KPEP00000462104335','KPEP00000668970125','KPEP00000021980317','KPEP00000458263919','KPEP00000422951228','KPEP00000337283222','KPEP00000751054218','KPEP00000048573909','KPEP00000324507933','KPEP00000393996125','KPEP00000058488333','KPEP00000869781636','KPEP00000062966905','KPEP00000737965907','KPEP00000996233216','KPEP00000426413240','KPEP00000583770903','KPEP00000532512832','KPEP00000267296804','KPEP00000724543515','KPEP00000057895830','KPEP00001044282731'
      )
      AND usr.realm_id != 'master'
),

LatestEvents AS (
    -- 2. Récupération du DERNIER événement pertinent par utilisateur identifié
    SELECT DISTINCT ON (evt.user_id)
        evt.user_id,
        evt.type,
        evt.client_id,
        evt.event_time
    FROM rcia.event_entity evt
    JOIN TargetUsers tu ON evt.user_id = tu.id
    WHERE evt.type IN ('LOGIN', 'UPDATE_PROFILE')
      AND TO_TIMESTAMP(evt.event_time / 1000)::date BETWEEN TO_TIMESTAMP('2000-03-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
                                                        AND TO_TIMESTAMP('2025-12-11 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
    ORDER BY evt.user_id, evt.event_time DESC
),

UserActivity AS (
    -- 3. Comparaison Création vs Dernier Événement pour choisir la ligne maître
    SELECT
        tu.id,
        tu.email,
        tu.first_name,
        tu.last_name,
        tu.kpep_searched,
        -- Timestamp final
        CASE 
            WHEN le.event_time IS NOT NULL AND le.event_time >= tu.created_timestamp THEN le.event_time
            ELSE tu.created_timestamp
        END as final_timestamp,
        -- Type final
        CASE 
            WHEN le.event_time IS NOT NULL AND le.event_time >= tu.created_timestamp THEN le.type
            ELSE 'CREATION'
        END as final_type,
        -- Client final
        CASE 
            WHEN le.event_time IS NOT NULL AND le.event_time >= tu.created_timestamp THEN le.client_id
            ELSE NULL
        END as final_client,
        -- Filtre de validité date global
        CASE
            WHEN le.event_time IS NOT NULL AND le.event_time >= tu.created_timestamp THEN 1
            WHEN TO_TIMESTAMP(tu.created_timestamp / 1000)::date BETWEEN TO_TIMESTAMP('2000-03-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
                                                                     AND TO_TIMESTAMP('2025-12-11 00:00:00', 'YYYY-MM-DD HH24:MI:SS') THEN 1
            ELSE 0
        END as is_valid
    FROM TargetUsers tu
    LEFT JOIN LatestEvents le ON tu.id = le.user_id
)

-- 4. Selection Finale et Jointure des Attributs (1 seule fois par KPEP trouvé)
SELECT DISTINCT ON (ua.kpep_searched)
    ua.id,
    COALESCE(attrealm.value, '') AS realm_id,
    ua.kpep_searched AS idkpep, -- On utilise la valeur du filtre initial
    ua.email,
    COALESCE(attother.value, '') AS email_other,
    COALESCE(attchannel.value, '') AS channel,
    ua.first_name,
    ua.last_name,
    COALESCE(attmiddle.value, '') AS middleName,
    COALESCE(attphone.value, '') AS phoneNumber,
    COALESCE(attbirth.value, '') AS birthDate,
    ua.final_type AS type,
    COALESCE(attorigin.value, '') AS originCreation,
    ua.final_client AS client,
    TO_TIMESTAMP(ua.final_timestamp/1000)::date AS date_evt,
    TO_TIMESTAMP(ua.final_timestamp/1000)::time AS heure_evt
FROM UserActivity ua
-- Jointures des attributs optimisées (uniquement sur les lignes gagnantes)
LEFT JOIN rcia.user_attribute attrealm ON ua.id = attrealm.user_id AND attrealm.name='societe-codeGestionnaire'
LEFT JOIN rcia.user_attribute attbirth ON ua.id = attbirth.user_id AND attbirth.name = 'birthDate'
LEFT JOIN rcia.user_attribute attother ON ua.id = attother.user_id AND attother.name = 'email_other'
LEFT JOIN rcia.user_attribute attchannel ON ua.id = attchannel.user_id AND attchannel.name = 'ActivationData-DeepLink-Chanel'
LEFT JOIN rcia.user_attribute attmiddle ON ua.id = attmiddle.user_id AND attmiddle.name = 'middleName'
LEFT JOIN rcia.user_attribute attphone ON ua.id = attphone.user_id AND attphone.name = 'phoneNumber'
LEFT JOIN rcia.user_attribute attorigin ON ua.id = attorigin.user_id AND attorigin.name = 'originCreation'
WHERE ua.is_valid = 1
ORDER BY ua.kpep_searched, date_evt DESC;